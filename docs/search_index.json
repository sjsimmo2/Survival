[["cox-survival-regression.html", "Chapter 4 Cox Survival Regression 4.1 Diagnostics", " Chapter 4 Cox Survival Regression The following code fits the Proportional Cox Hazard model. # Proportional Hazards Model # recid.ph &lt;- coxph(Surv(week, arrest) ~ fin + age + wexp + mar +paro + prio, data = recid) summary(recid.ph) ## Call: ## coxph(formula = Surv(week, arrest) ~ fin + age + wexp + mar + ## paro + prio, data = recid) ## ## n= 432, number of events= 114 ## ## coef exp(coef) se(coef) z Pr(&gt;|z|) ## fin -0.36554 0.69382 0.19090 -1.915 0.05552 . ## age -0.05633 0.94523 0.02189 -2.573 0.01007 * ## wexp -0.15699 0.85471 0.21208 -0.740 0.45916 ## mar -0.47130 0.62419 0.38027 -1.239 0.21520 ## paro -0.07792 0.92504 0.19530 -0.399 0.68991 ## prio 0.08966 1.09380 0.02871 3.123 0.00179 ** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## exp(coef) exp(-coef) lower .95 upper .95 ## fin 0.6938 1.4413 0.4773 1.0087 ## age 0.9452 1.0579 0.9055 0.9867 ## wexp 0.8547 1.1700 0.5640 1.2952 ## mar 0.6242 1.6021 0.2962 1.3152 ## paro 0.9250 1.0810 0.6308 1.3564 ## prio 1.0938 0.9142 1.0340 1.1571 ## ## Concordance= 0.639 (se = 0.027 ) ## Likelihood ratio test= 32.14 on 6 df, p=2e-05 ## Wald test = 30.79 on 6 df, p=3e-05 ## Score (logrank) test = 32.28 on 6 df, p=1e-05 # Parameter Interpretation # recid.ph2 &lt;- coxph(Surv(week, arrest) ~ fin + age + prio, data = recid) summary(recid.ph2) ## Call: ## coxph(formula = Surv(week, arrest) ~ fin + age + prio, data = recid) ## ## n= 432, number of events= 114 ## ## coef exp(coef) se(coef) z Pr(&gt;|z|) ## fin -0.34695 0.70684 0.19025 -1.824 0.068197 . ## age -0.06711 0.93510 0.02085 -3.218 0.001289 ** ## prio 0.09689 1.10174 0.02725 3.555 0.000378 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## exp(coef) exp(-coef) lower .95 upper .95 ## fin 0.7068 1.4148 0.4868 1.0263 ## age 0.9351 1.0694 0.8977 0.9741 ## prio 1.1017 0.9077 1.0444 1.1622 ## ## Concordance= 0.63 (se = 0.027 ) ## Likelihood ratio test= 29.05 on 3 df, p=2e-06 ## Wald test = 27.94 on 3 df, p=4e-06 ## Score (logrank) test = 29.03 on 3 df, p=2e-06 (exp(coef(recid.ph2))-1)*100 ## fin age prio ## -29.31625 -6.49033 10.17427 # Automatic Selection Techniques # full.model &lt;- coxph(Surv(week, arrest) ~ fin + age + wexp + mar +paro + prio, data = recid) empty.model &lt;- coxph(Surv(week, arrest ) ~ 1, data = recid) step.model &lt;- step(empty.model, scope = list(lower=formula(empty.model), upper=formula(full.model)), direction = &quot;both&quot;) ## Start: AIC=1350.76 ## Surv(week, arrest) ~ 1 ## ## Df AIC ## + age 1 1337.5 ## + prio 1 1340.8 ## + wexp 1 1343.1 ## + mar 1 1348.1 ## + fin 1 1348.9 ## &lt;none&gt; 1350.8 ## + paro 1 1352.4 ## ## Step: AIC=1337.49 ## Surv(week, arrest) ~ age ## ## Df AIC ## + prio 1 1329.1 ## + wexp 1 1336.4 ## + fin 1 1336.5 ## &lt;none&gt; 1337.5 ## + mar 1 1337.5 ## + paro 1 1338.6 ## - age 1 1350.8 ## ## Step: AIC=1329.08 ## Surv(week, arrest) ~ age + prio ## ## Df AIC ## + fin 1 1327.7 ## + mar 1 1329.0 ## &lt;none&gt; 1329.1 ## + wexp 1 1330.0 ## + paro 1 1330.9 ## - prio 1 1337.5 ## - age 1 1340.8 ## ## Step: AIC=1327.71 ## Surv(week, arrest) ~ age + prio + fin ## ## Df AIC ## + mar 1 1327.3 ## &lt;none&gt; 1327.7 ## + wexp 1 1328.6 ## - fin 1 1329.1 ## + paro 1 1329.4 ## - prio 1 1336.5 ## - age 1 1338.3 ## ## Step: AIC=1327.35 ## Surv(week, arrest) ~ age + prio + fin + mar ## ## Df AIC ## &lt;none&gt; 1327.3 ## - mar 1 1327.7 ## + wexp 1 1328.8 ## - fin 1 1329.0 ## + paro 1 1329.2 ## - age 1 1335.4 ## - prio 1 1336.2 summary(step.model) ## Call: ## coxph(formula = Surv(week, arrest) ~ age + prio + fin + mar, ## data = recid) ## ## n= 432, number of events= 114 ## ## coef exp(coef) se(coef) z Pr(&gt;|z|) ## age -0.06042 0.94137 0.02085 -2.897 0.00376 ** ## prio 0.09751 1.10243 0.02722 3.583 0.00034 *** ## fin -0.36020 0.69753 0.19049 -1.891 0.05864 . ## mar -0.53312 0.58677 0.37276 -1.430 0.15266 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## exp(coef) exp(-coef) lower .95 upper .95 ## age 0.9414 1.0623 0.9037 0.9806 ## prio 1.1024 0.9071 1.0452 1.1628 ## fin 0.6975 1.4336 0.4802 1.0132 ## mar 0.5868 1.7042 0.2826 1.2183 ## ## Concordance= 0.633 (se = 0.027 ) ## Likelihood ratio test= 31.41 on 4 df, p=3e-06 ## Wald test = 29.98 on 4 df, p=5e-06 ## Score (logrank) test = 31.25 on 4 df, p=3e-06 full.model &lt;- coxph(Surv(week, arrest) ~ fin + age + wexp + mar +paro + prio, data = recid) back.model &lt;- step(full.model, direction = &quot;backward&quot;) ## Start: AIC=1330.62 ## Surv(week, arrest) ~ fin + age + wexp + mar + paro + prio ## ## Df AIC ## - paro 1 1328.8 ## - wexp 1 1329.2 ## - mar 1 1330.3 ## &lt;none&gt; 1330.6 ## - fin 1 1332.3 ## - age 1 1336.3 ## - prio 1 1337.2 ## ## Step: AIC=1328.78 ## Surv(week, arrest) ~ fin + age + wexp + mar + prio ## ## Df AIC ## - wexp 1 1327.3 ## - mar 1 1328.6 ## &lt;none&gt; 1328.8 ## - fin 1 1330.4 ## - age 1 1334.3 ## - prio 1 1335.8 ## ## Step: AIC=1327.35 ## Surv(week, arrest) ~ fin + age + mar + prio ## ## Df AIC ## &lt;none&gt; 1327.3 ## - mar 1 1327.7 ## - fin 1 1329.0 ## - age 1 1335.4 ## - prio 1 1336.2 summary(back.model) ## Call: ## coxph(formula = Surv(week, arrest) ~ fin + age + mar + prio, ## data = recid) ## ## n= 432, number of events= 114 ## ## coef exp(coef) se(coef) z Pr(&gt;|z|) ## fin -0.36020 0.69753 0.19049 -1.891 0.05864 . ## age -0.06042 0.94137 0.02085 -2.897 0.00376 ** ## mar -0.53312 0.58677 0.37276 -1.430 0.15266 ## prio 0.09751 1.10243 0.02722 3.583 0.00034 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## exp(coef) exp(-coef) lower .95 upper .95 ## fin 0.6975 1.4336 0.4802 1.0132 ## age 0.9414 1.0623 0.9037 0.9806 ## mar 0.5868 1.7042 0.2826 1.2183 ## prio 1.1024 0.9071 1.0452 1.1628 ## ## Concordance= 0.633 (se = 0.027 ) ## Likelihood ratio test= 31.41 on 4 df, p=3e-06 ## Wald test = 29.98 on 4 df, p=5e-06 ## Score (logrank) test = 31.25 on 4 df, p=3e-06 full.model &lt;- coxph(Surv(week, arrest) ~ fin + age + wexp + mar +paro + prio, data = recid) empty.model &lt;- coxph(Surv(week, arrest) ~ 1, data = recid) for.model &lt;- step(empty.model, scope = list(lower=formula(empty.model), upper=formula(full.model)), direction = &quot;forward&quot;) ## Start: AIC=1350.76 ## Surv(week, arrest) ~ 1 ## ## Df AIC ## + age 1 1337.5 ## + prio 1 1340.8 ## + wexp 1 1343.1 ## + mar 1 1348.1 ## + fin 1 1348.9 ## &lt;none&gt; 1350.8 ## + paro 1 1352.4 ## ## Step: AIC=1337.49 ## Surv(week, arrest) ~ age ## ## Df AIC ## + prio 1 1329.1 ## + wexp 1 1336.4 ## + fin 1 1336.5 ## &lt;none&gt; 1337.5 ## + mar 1 1337.5 ## + paro 1 1338.6 ## ## Step: AIC=1329.08 ## Surv(week, arrest) ~ age + prio ## ## Df AIC ## + fin 1 1327.7 ## + mar 1 1329.0 ## &lt;none&gt; 1329.1 ## + wexp 1 1330.0 ## + paro 1 1330.9 ## ## Step: AIC=1327.71 ## Surv(week, arrest) ~ age + prio + fin ## ## Df AIC ## + mar 1 1327.3 ## &lt;none&gt; 1327.7 ## + wexp 1 1328.6 ## + paro 1 1329.4 ## ## Step: AIC=1327.35 ## Surv(week, arrest) ~ age + prio + fin + mar ## ## Df AIC ## &lt;none&gt; 1327.3 ## + wexp 1 1328.8 ## + paro 1 1329.2 summary(for.model) ## Call: ## coxph(formula = Surv(week, arrest) ~ age + prio + fin + mar, ## data = recid) ## ## n= 432, number of events= 114 ## ## coef exp(coef) se(coef) z Pr(&gt;|z|) ## age -0.06042 0.94137 0.02085 -2.897 0.00376 ** ## prio 0.09751 1.10243 0.02722 3.583 0.00034 *** ## fin -0.36020 0.69753 0.19049 -1.891 0.05864 . ## mar -0.53312 0.58677 0.37276 -1.430 0.15266 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## exp(coef) exp(-coef) lower .95 upper .95 ## age 0.9414 1.0623 0.9037 0.9806 ## prio 1.1024 0.9071 1.0452 1.1628 ## fin 0.6975 1.4336 0.4802 1.0132 ## mar 0.5868 1.7042 0.2826 1.2183 ## ## Concordance= 0.633 (se = 0.027 ) ## Likelihood ratio test= 31.41 on 4 df, p=3e-06 ## Wald test = 29.98 on 4 df, p=5e-06 ## Score (logrank) test = 31.25 on 4 df, p=3e-06 # Estimated Survival Curves # newdata &lt;- data.frame(fin = c(1, 0), age = 30, wexp = c(1, 0), mar = 0, paro = 0, prio = c(0, 4)) ggsurvplot(survfit(recid.ph, newdata), data = newdata, break.y.by = 0.1, palette = c(&quot;purple&quot;, &quot;black&quot;), ylab = &quot;survival probability&quot;, xlab = &quot;week&quot;, legend.labs = c(&quot;1&quot;, &quot;2&quot;), legend.title = &quot;subject&quot;) ## Warning: `gather_()` was deprecated in tidyr 1.2.0. ## Please use `gather()` instead. ## This warning is displayed once every 8 hours. ## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated. 4.1 Diagnostics Assumptions made for the Cox PH model is linearity for the continuous variables and proportional hazards throughout time (i.e.Â at EACH time point, the proportion between the hazards remains the same!). We can assess both of these through use of residuals. # Concordance recid.ph = coxph(Surv(week, arrest) ~ fin + age + prio, data = recid) concordance(recid.ph) ## Call: ## concordance.coxph(object = recid.ph) ## ## n= 432 ## Concordance= 0.6302 se= 0.02729 ## concordant discordant tied.x tied.y tied.xy ## 26736 15651 195 111 0 ## Partial residuals...Linearity recid.ph &lt;- coxph(Surv(week, arrest) ~ fin + age + wexp + mar +paro + prio, data = recid) visreg(recid.ph, &quot;age&quot;, xlab = &quot;age&quot;, ylab = &quot;partial residuals&quot;, gg = TRUE, band = FALSE) + geom_smooth(col = &quot;red&quot;, fill = &quot;red&quot;) + theme_bw() ## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39; visreg(recid.ph, &quot;prio&quot;, xlab = &quot;#prior convictions&quot;, ylab = &quot;partial residuals&quot;, gg = TRUE, band = FALSE) + geom_smooth(col = &quot;red&quot;, fill = &quot;red&quot;) + theme_bw() ## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39; ## Martingale residuals...Linearity recid.lin &lt;- coxph(Surv(week, arrest) ~ age + prio, data = recid) survminer::ggcoxfunctional(recid.lin,data=recid) ## Try transformations or can bin recid.lin &lt;- coxph(Surv(week, arrest) ~ sqrt(age) , data = recid) survminer::ggcoxfunctional(recid.lin,data=recid) # Proportional Hazard Test - Schoenfeld Residuals recid.ph.zph &lt;- cox.zph(recid.ph, transform = &quot;identity&quot;) recid.ph.zph ## chisq df p ## fin 0.00878 1 0.9254 ## age 6.55134 1 0.0105 ## wexp 3.94780 1 0.0469 ## mar 1.04080 1 0.3076 ## paro 0.02280 1 0.8800 ## prio 0.42929 1 0.5123 ## GLOBAL 16.85230 6 0.0098 ggcoxzph(recid.ph.zph) # Can try transformations.. recid.ph.zph2 = cox.zph(recid.ph, transform = &quot;km&quot;) recid.ph.zph2 ## chisq df p ## fin 0.0621 1 0.803 ## age 5.9161 1 0.015 ## wexp 4.2983 1 0.038 ## mar 1.0207 1 0.312 ## paro 0.0140 1 0.906 ## prio 0.5254 1 0.469 ## GLOBAL 16.4474 6 0.012 recid.ph.zph3 = cox.zph(recid.ph, transform = &quot;identity&quot;) recid.ph.zph3 ## chisq df p ## fin 0.00878 1 0.9254 ## age 6.55134 1 0.0105 ## wexp 3.94780 1 0.0469 ## mar 1.04080 1 0.3076 ## paro 0.02280 1 0.8800 ## prio 0.42929 1 0.5123 ## GLOBAL 16.85230 6 0.0098 recid.ph.zph4 = cox.zph(recid.ph, transform = &quot;log&quot;) recid.ph.zph4 ## chisq df p ## fin 0.1391 1 0.7092 ## age 8.1533 1 0.0043 ## wexp 2.1341 1 0.1441 ## mar 1.1319 1 0.2874 ## paro 0.2092 1 0.6474 ## prio 0.0126 1 0.9105 ## GLOBAL 16.6501 6 0.0107 If we believe that the PH assumption is not true for one (or more) variables, then we can explore what type of relationship is the best (with respect to time). Options are identity, log and KM (although identity and log are the most commonly used). The first part of the code below illustrates how to fit the time-dependent coefficients. The second part of the R code below illustrates how to fit time-varying variables (variables that change their values throughout time). # Time-Dependent Coefficients # recid.ph.tdc &lt;- coxph(Surv(week, arrest) ~ fin + wexp + mar + paro + prio+ age + tt(age), data = recid, tt = function(x, time, ...){x*log(time)}) summary(recid.ph.tdc) ## Call: ## coxph(formula = Surv(week, arrest) ~ fin + wexp + mar + paro + ## prio + age + tt(age), data = recid, tt = function(x, time, ## ...) { ## x * log(time) ## }) ## ## n= 432, number of events= 114 ## ## coef exp(coef) se(coef) z Pr(&gt;|z|) ## fin -0.36527 0.69401 0.19087 -1.914 0.05566 . ## wexp -0.13317 0.87531 0.21247 -0.627 0.53080 ## mar -0.45279 0.63585 0.38041 -1.190 0.23394 ## paro -0.08490 0.91860 0.19534 -0.435 0.66382 ## prio 0.09177 1.09611 0.02880 3.186 0.00144 ** ## age 0.12174 1.12946 0.06535 1.863 0.06249 . ## tt(age) -0.05931 0.94242 0.02182 -2.718 0.00658 ** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## exp(coef) exp(-coef) lower .95 upper .95 ## fin 0.6940 1.4409 0.4774 1.0089 ## wexp 0.8753 1.1424 0.5772 1.3275 ## mar 0.6358 1.5727 0.3017 1.3402 ## paro 0.9186 1.0886 0.6264 1.3471 ## prio 1.0961 0.9123 1.0359 1.1598 ## age 1.1295 0.8854 0.9937 1.2838 ## tt(age) 0.9424 1.0611 0.9030 0.9836 ## ## Concordance= 0.648 (se = 0.027 ) ## Likelihood ratio test= 38.72 on 7 df, p=2e-06 ## Wald test = 35.09 on 7 df, p=1e-05 ## Score (logrank) test = 36.97 on 7 df, p=5e-06 recid.ph.tdc &lt;- coxph(Surv(week, arrest) ~ fin + prio + age + tt(age), data = recid, tt = function(x, time, ...){x*log(time)}) summary(recid.ph.tdc) ## Call: ## coxph(formula = Surv(week, arrest) ~ fin + prio + age + tt(age), ## data = recid, tt = function(x, time, ...) { ## x * log(time) ## }) ## ## n= 432, number of events= 114 ## ## coef exp(coef) se(coef) z Pr(&gt;|z|) ## fin -0.34878 0.70555 0.19025 -1.833 0.066762 . ## prio 0.09837 1.10337 0.02731 3.603 0.000315 *** ## age 0.11991 1.12739 0.06623 1.810 0.070220 . ## tt(age) -0.06195 0.93993 0.02207 -2.807 0.005005 ** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## exp(coef) exp(-coef) lower .95 upper .95 ## fin 0.7055 1.4173 0.4859 1.0244 ## prio 1.1034 0.9063 1.0459 1.1640 ## age 1.1274 0.8870 0.9901 1.2837 ## tt(age) 0.9399 1.0639 0.9001 0.9815 ## ## Concordance= 0.635 (se = 0.028 ) ## Likelihood ratio test= 36 on 4 df, p=3e-07 ## Wald test = 32.41 on 4 df, p=2e-06 ## Score (logrank) test = 33.75 on 4 df, p=8e-07 # Time Varying Variables # recid_long.ph &lt;- coxph(Surv(start, stop, arrested) ~ fin + age + prio + employed, data = recid_long) summary(recid_long.ph) ## Call: ## coxph(formula = Surv(start, stop, arrested) ~ fin + age + prio + ## employed, data = recid_long) ## ## n= 19809, number of events= 114 ## ## coef exp(coef) se(coef) z Pr(&gt;|z|) ## fin -0.33051 0.71856 0.19012 -1.738 0.08214 . ## age -0.04977 0.95145 0.02053 -2.424 0.01537 * ## prio 0.08364 1.08724 0.02775 3.014 0.00258 ** ## employed -1.34815 0.25972 0.24928 -5.408 6.37e-08 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## exp(coef) exp(-coef) lower .95 upper .95 ## fin 0.7186 1.3917 0.4950 1.0430 ## age 0.9515 1.0510 0.9139 0.9905 ## prio 1.0872 0.9198 1.0297 1.1480 ## employed 0.2597 3.8503 0.1593 0.4233 ## ## Concordance= 0.703 (se = 0.023 ) ## Likelihood ratio test= 66.19 on 4 df, p=1e-13 ## Wald test = 53.93 on 4 df, p=5e-11 ## Score (logrank) test = 62.05 on 4 df, p=1e-12 recid_lag.ph &lt;- coxph(Surv(start, stop, arrested) ~ fin + age + prio + employed, data = recid_lag) summary(recid_lag.ph) ## Call: ## coxph(formula = Surv(start, stop, arrested) ~ fin + age + prio + ## employed, data = recid_lag) ## ## n= 19377, number of events= 113 ## ## coef exp(coef) se(coef) z Pr(&gt;|z|) ## fin -0.32464 0.72278 0.19077 -1.702 0.088803 . ## age -0.05462 0.94685 0.02073 -2.635 0.008409 ** ## prio 0.09158 1.09590 0.02753 3.326 0.000880 *** ## employed -0.81123 0.44431 0.21648 -3.747 0.000179 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## exp(coef) exp(-coef) lower .95 upper .95 ## fin 0.7228 1.3835 0.4973 1.0505 ## age 0.9468 1.0561 0.9092 0.9861 ## prio 1.0959 0.9125 1.0383 1.1567 ## employed 0.4443 2.2507 0.2907 0.6791 ## ## Concordance= 0.665 (se = 0.027 ) ## Likelihood ratio test= 44.5 on 4 df, p=5e-09 ## Wald test = 40.91 on 4 df, p=3e-08 ## Score (logrank) test = 43.68 on 4 df, p=7e-09 "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
